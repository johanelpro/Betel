<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Betel - Chatbot Bíblico</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M8 3H13.5C16.5376 3 19 5.46243 19 8.5C19 11.5376 16.5376 14 13.5 14H8V3Z' fill='%23D4AF37'/><path d='M8 12H14.5C16.9853 12 19 14.0147 19 16.5C19 18.9853 16.9853 21 14.5 21H8V12Z' fill='%23F5F5F7'/><path d='M8 3V21' stroke='%230D0F1A' stroke-width='1.5'/><path d='M5 3V21' stroke='%23F5F5F7' stroke-width='1.5' stroke-linecap='round'/></svg>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter & Source Sans Pro -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Source+Sans+Pro:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        /* Aplicamos las fuentes y colores base definidos */
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle, #1A2033, #0D0F1A);
            color: #F5F5F7;
        }

        /* Efecto de vidrio esmerilado BASE */
        .glass-effect {
            background: rgba(255, 255, 255, 0.05);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        /* Estilos para las nuevas burbujas de chat con efecto de vidrio */
        .chat-bubble {
            padding: 12px 16px;
            border-radius: 20px;
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 16px;
            line-height: 1.5;
            transition: all 0.3s ease-in-out;
            word-wrap: break-word;
        }

        .chat-bubble-user {
            background: rgba(135, 206, 235, 0.1); /* Tinte azulado */
            align-self: flex-end;
            max-width: 60%;
            border-bottom-right-radius: 4px;
        }

        .chat-bubble-betel {
            background: rgba(255, 255, 255, 0.1); /* Tinte neutro */
            align-self: flex-start;
            max-width: 75%;
            border-bottom-left-radius: 4px;
        }
        
        /* Indicador de "escribiendo..." */
        .typing-indicator span {
            height: 8px;
            width: 8px;
            background-color: #A1A1A6;
            display: inline-block;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-of-type(2) { animation-delay: -0.2s; }
        .typing-indicator span:nth-of-type(3) { animation-delay: -0.4s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }


        /* Oculta la barra de scroll en el chat para un diseño más limpio */
        #chat-history, .conversation-list {
          -ms-overflow-style: none;  /* IE y Edge */
          scrollbar-width: none;  /* Firefox */
        }
        #chat-history::-webkit-scrollbar, .conversation-list::-webkit-scrollbar {
          display: none; /* Chrome, Safari y Opera */
        }


        /* Input placeholder styling */
        .chat-input::placeholder {
            color: #A1A1A6;
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 18px;
        }

        /* Estilos para la barra lateral */
        .conversation-item {
            font-family: 'Source Sans Pro', sans-serif;
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
        }
        .conversation-container.active {
            background: rgba(212, 175, 55, 0.2);
        }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-row">

    <!-- Barra Lateral -->
    <aside id="sidebar" class="w-20 h-full p-4 flex flex-col gap-4 glass-effect border-r border-white/10 transition-all duration-300 ease-in-out">
        <!-- Botón de Nuevo Chat -->
        <button id="new-chat-button" class="w-full h-12 flex items-center justify-center rounded-lg glass-effect transition-all duration-300 ease-in-out hover:bg-white/10 overflow-hidden">
            <svg class="flex-shrink-0" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            <span id="new-chat-button-text" class="whitespace-nowrap max-w-0 opacity-0 transition-all duration-300 ease-in-out">Nueva Conversación</span>
        </button>
        <!-- Lista de Conversaciones -->
        <div class="flex-grow conversation-list opacity-0 transition-opacity duration-200 ease-in-out delay-100 overflow-y-auto flex flex-col gap-2 pr-2">
            <!-- Las conversaciones se insertarán aquí dinámicamente -->
        </div>
    </aside>

    <!-- Contenido Principal -->
    <div class="flex-1 flex flex-col">
        <!-- Encabezado Superior Minimalista -->
        <header class="w-full flex items-center justify-between p-6 flex-shrink-0 z-10">
            <!-- Izquierda: Logo y Nombre -->
            <div class="glass-effect flex items-center gap-3 px-4 py-2 rounded-full">
                <div class="w-[32px] h-[32px]">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8 3H13.5C16.5376 3 19 5.46243 19 8.5C19 11.5376 16.5376 14 13.5 14H8V3Z" fill="#D4AF37"/><path d="M8 12H14.5C16.9853 12 19 14.0147 19 16.5C19 18.9853 16.9853 21 14.5 21H8V12Z" fill="#F5F5F7"/><path d="M8 3V21" stroke="#0D0F1A" stroke-width="1.5"/><path d="M5 3V21" stroke="#F5F5F7" stroke-width="1.5" stroke-linecap="round"/></svg>
                </div>
                <h1 style="font-family: 'Inter', sans-serif; font-weight: 500; font-size: 18px; color: #F5F5F7;">Betel</h1>
            </div>
            
            <!-- Derecha: Botón de Perfil -->
            <button class="glass-effect w-12 h-12 rounded-full flex items-center justify-center transition-colors hover:bg-white/10" title="Perfil">
                <svg class="text-[#F5F5F7]" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            </button>
        </header>
        
        <!-- Contenedor de Chat y Animación -->
        <main class="flex-grow flex flex-col relative -mt-[104px] h-full">
            <!-- Pantalla de Bienvenida (se desvanecerá) -->
            <div id="welcome-screen" class="absolute inset-0 flex flex-col items-center justify-center pb-48 transition-opacity duration-500 ease-in-out opacity-100">
                <div class="w-3/5 max-w-3xl flex flex-col items-center mb-8">
                    <h1 class="text-[32px] font-medium text-center" style="font-family: 'Inter', sans-serif; text-shadow: 0 0 15px rgba(200, 200, 255, 0.3);">
                        ¿Qué quieres explorar en las Escrituras hoy?
                    </h1>
                </div>
            </div>

            <!-- Vista de Chat (aparecerá) -->
            <div id="chat-view" class="w-3/5 max-w-3xl mx-auto h-full flex flex-col pt-[104px] pb-28 px-6 transition-opacity duration-500 ease-in-out opacity-0 pointer-events-none">
                <!-- Historial de Chat -->
                <div id="chat-history" class="flex-grow flex flex-col gap-4 overflow-y-auto px-2">
                    <!-- Los mensajes del chat se insertarán aquí -->
                </div>
            </div>

            <!-- Input Bar (elemento que se anima) -->
            <div id="animated-input-bar" class="absolute w-3/5 max-w-3xl left-1/2 top-1/2 -translate-x-1/2 -translate-y-12 transition-all duration-700 ease-in-out">
                <div class="w-full h-[72px] glass-effect rounded-[24px] flex items-center px-[24px]">
                    <input type="text" id="chat-input" class="chat-input flex-grow h-full bg-transparent border-none outline-none text-[#F5F5F7]" placeholder="Busca en las escrituras o haz una pregunta...">
                    <button id="send-button" title="Enviar">
                        <svg id="send-icon" class="text-[#A1A1A6]" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        const webhookUrl = 'https://webhook.wipti.com/webhook/47420ae2-9f8e-4800-a613-b385e6247500';

        // Elementos del DOM
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const sendIcon = document.getElementById('send-icon');
        const welcomeScreen = document.getElementById('welcome-screen');
        const chatView = document.getElementById('chat-view');
        const animatedInputBar = document.getElementById('animated-input-bar');
        const chatHistory = document.getElementById('chat-history');
        const newChatButton = document.getElementById('new-chat-button');
        const conversationList = document.querySelector('.conversation-list');
        const sidebar = document.getElementById('sidebar');
        const newChatButtonText = document.getElementById('new-chat-button-text');

        // Estado de la aplicación
        let conversations = [];
        let activeConversationId = null;
        let expansionTimeout; // Para el efecto de hover de la barra lateral

        function init() {
            loadConversations();
            if (conversations.length === 0) {
                startNewConversation();
            } else {
                switchConversation(conversations[0].id);
            }
            renderConversationList();
            setupEventListeners();
        }

        function setupEventListeners() {
            sendButton.addEventListener('click', handleUserMessage);
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleUserMessage();
                }
            });
            chatInput.addEventListener('input', updateSendIcon);
            newChatButton.addEventListener('click', () => {
                startNewConversation();
                resetChatViewUI();
            });
            sidebar.addEventListener('mouseenter', handleSidebarEnter);
            sidebar.addEventListener('mouseleave', handleSidebarLeave);
        }

        function handleSidebarEnter() {
            clearTimeout(expansionTimeout); // Limpiar cualquier colapso pendiente
            expansionTimeout = setTimeout(() => {
                sidebar.classList.replace('w-20', 'w-72');
                newChatButton.classList.remove('justify-center');
                newChatButton.classList.add('gap-3', 'px-4'); // Añadir gap y padding al expandir
                newChatButtonText.classList.replace('opacity-0', 'opacity-100');
                newChatButtonText.classList.replace('max-w-0', 'max-w-xs'); // Animar ancho para evitar saltos
                conversationList.classList.replace('opacity-0', 'opacity-100');
            }, 300); // Retraso de 0.3 segundos para expandir
        }

        function handleSidebarLeave() {
            clearTimeout(expansionTimeout); // Cancelar la expansión si el ratón sale antes de tiempo
            sidebar.classList.replace('w-72', 'w-20');
            newChatButton.classList.add('justify-center');
            newChatButton.classList.remove('gap-3', 'px-4'); // Quitar gap y padding al colapsar
            newChatButtonText.classList.replace('opacity-100', 'opacity-0');
            newChatButtonText.classList.replace('max-w-xs', 'max-w-0'); // Animar ancho para evitar saltos
            conversationList.classList.replace('opacity-100', 'opacity-0');
        }
        
        function resetChatViewUI() {
            chatHistory.innerHTML = '';
            welcomeScreen.style.display = 'flex';
            animatedInputBar.style.top = '50%';
            animatedInputBar.style.bottom = 'auto';
            animatedInputBar.style.transform = 'translateX(-50%) translateY(-2.75rem)'; // -translate-y-12
            setTimeout(() => { 
                welcomeScreen.style.opacity = '1';
                chatView.style.opacity = '0';
                chatView.style.pointerEvents = 'none';
            }, 10);
        }

        function loadConversations() {
            const storedConvos = localStorage.getItem('betel_conversations');
            if (storedConvos) {
                conversations = JSON.parse(storedConvos);
            }
        }

        function saveConversations() {
            localStorage.setItem('betel_conversations', JSON.stringify(conversations));
        }
        
        function startNewConversation() {
            const newConversation = {
                id: Date.now().toString(),
                title: 'Nueva Conversación',
                messages: []
            };
            conversations.unshift(newConversation);
            activeConversationId = newConversation.id;
            saveConversations();
            renderConversationList();
            switchConversation(activeConversationId);
        }

        function deleteConversation(idToDelete) {
            // Filtrar para eliminar la conversación
            conversations = conversations.filter(c => c.id !== idToDelete);

            // Si se eliminó la conversación activa...
            if (activeConversationId === idToDelete) {
                // ...y todavía hay otras, cambiar a la primera.
                if (conversations.length > 0) {
                    switchConversation(conversations[0].id);
                } else {
                    // ...si era la última, iniciar una nueva.
                    startNewConversation();
                }
            }
            
            saveConversations();
            renderConversationList();
        }

        function switchConversation(id) {
            activeConversationId = id;
            const conversation = conversations.find(c => c.id === id);
            chatHistory.innerHTML = '';
            
            if (conversation && conversation.messages.length > 0) {
                conversation.messages.forEach(msg => addMessage(msg.text, msg.type, false));
                welcomeScreen.style.opacity = '0';
                welcomeScreen.style.display = 'none';
                chatView.style.opacity = '1';
                chatView.style.pointerEvents = 'auto';
                
                // Asegurarse de que la barra de input esté en la posición de chat
                animatedInputBar.style.top = 'auto';
                animatedInputBar.style.bottom = '1.5rem';
                animatedInputBar.style.transform = 'translateX(-50%) translateY(0)';
            } else {
                resetChatViewUI();
            }
            renderConversationList();
        }

        function renderConversationList() {
            conversationList.innerHTML = '';
            conversations.forEach(convo => {
                const container = document.createElement('div');
                container.className = `w-full flex items-center rounded-lg transition-colors hover:bg-white/10 conversation-container ${convo.id === activeConversationId ? 'active' : ''}`;

                const switchButton = document.createElement('button');
                switchButton.className = 'flex-grow text-left p-3 conversation-item';
                switchButton.textContent = convo.title;
                switchButton.onclick = () => switchConversation(convo.id);

                const deleteButton = document.createElement('button');
                deleteButton.className = 'p-3 text-gray-400 hover:text-white transition-colors flex-shrink-0';
                deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
                deleteButton.title = 'Eliminar conversación';
                deleteButton.onclick = (event) => {
                    event.stopPropagation(); // Evita que se active el switchConversation
                    deleteConversation(convo.id);
                };
                
                container.appendChild(switchButton);
                container.appendChild(deleteButton);
                conversationList.appendChild(container);
            });
        }
        
        function handleUserMessage() {
            const message = chatInput.value.trim();
            if (message === '') return;
            
            const currentConvo = conversations.find(c => c.id === activeConversationId);
            const isFirstMessage = currentConvo && currentConvo.messages.length === 0;

            if (isFirstMessage) {
                // Iniciar animación de la UI
                welcomeScreen.style.opacity = '0';
                animatedInputBar.style.top = 'auto';
                animatedInputBar.style.bottom = '1.5rem';
                animatedInputBar.style.transform = 'translateX(-50%) translateY(0)';
                
                setTimeout(() => {
                    welcomeScreen.style.display = 'none';
                    chatView.style.opacity = '1';
                    chatView.style.pointerEvents = 'auto';
                    sendMessage(message);
                }, 500);
            } else {
                sendMessage(message);
            }
        }

        async function sendMessage(message) {
            addMessage(message, 'user');
            
            const conversation = conversations.find(c => c.id === activeConversationId);
            if (conversation.messages.length === 1) { // Era el primer mensaje
                conversation.title = message;
                renderConversationList();
            }

            chatInput.value = '';
            updateSendIcon();
            showTypingIndicator();

            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: message })
                });

                removeTypingIndicator();

                if (!response.ok) throw new Error(`Error del Webhook: ${response.statusText}`);
                
                const data = await response.json();
                
                if (data.response) {
                    addMessage(data.response, 'betel');
                } else {
                    addMessage('Hubo un error al procesar la respuesta.', 'betel');
                }

            } catch (error) {
                console.error('Error al contactar el webhook:', error);
                removeTypingIndicator();
                addMessage('Lo siento, no pude conectarme para obtener una respuesta.', 'betel');
            }
        }

        function addMessage(text, type, shouldSave = true) {
            const bubble = document.createElement('div');
            bubble.textContent = text;
            bubble.className = `chat-bubble glass-effect ${type === 'user' ? 'chat-bubble-user' : 'chat-bubble-betel'}`;
            chatHistory.appendChild(bubble);
            chatHistory.scrollTop = chatHistory.scrollHeight;

            if (shouldSave) {
                const conversation = conversations.find(c => c.id === activeConversationId);
                if(conversation) {
                    conversation.messages.push({ text, type });
                    saveConversations();
                }
            }
        }
        
        function showTypingIndicator() {
            const typingBubble = document.createElement('div');
            typingBubble.id = 'typing-indicator';
            typingBubble.className = 'chat-bubble glass-effect chat-bubble-betel typing-indicator';
            typingBubble.innerHTML = '<span></span><span></span><span></span>';
            chatHistory.appendChild(typingBubble);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }
        
        function updateSendIcon() {
            if (chatInput.value.trim() !== '') {
                sendIcon.classList.remove('text-[#A1A1A6]');
                sendIcon.classList.add('text-[#D4AF37]');
            } else {
                sendIcon.classList.remove('text-[#D4AF37]');
                sendIcon.classList.add('text-[#A1A1A6]');
            }
        }
        
        // Iniciar la aplicación cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', init);
        
    </script>

</body>
</html>







